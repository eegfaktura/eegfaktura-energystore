package test

import (
	"at.ourproject/energystore/calculation"
	"at.ourproject/energystore/model"
	"at.ourproject/energystore/store"
	"fmt"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
	"os"
	"testing"
)

func TestCalculateReports(t *testing.T) {

	db, err := store.OpenStorageTest("excelsource", "../test/rawdata")
	require.NoError(t, err)
	defer func() {
		db.Close()
		os.RemoveAll("../test/rawdata/excelsource")
	}()

	for _, k := range ImportTestContent(t, "./zaehlpunkte-beispieldatei.xlsx", "ConsumptionDataReport", db) {
		err = calculation.CalculateMonthlyDash(db, fmt.Sprintf("%d", k), calculation.CalculateEEG)
		require.NoError(t, err)
	}

	t.Run("Calc yearly report", func(t *testing.T) {
		results, report, err := calculation.CalculateYearlyReport(db, 2021, calculation.CalculateEEG)
		require.NoError(t, err)
		require.NotNil(t, results)
		require.NotNil(t, report)
		require.NotNil(t, report.Allocated)

		expectedResult := []*model.EnergyReport{
			{Id: "MRP/2021/01", Allocated: []float64{32.554336924099495, 15.279570101331027, 28.427825704277588, 21.76970060378616, 22.61920932563601, 20.632024956200294, 18.976233156696786, 8.930696764022306, 26.378684434060222, 17.069988530894747, 12.113755135444393, 16.26101284182286, 5.622119537712765, 13.58091306898057, 19.52248362423112, 6.54028103031349, 8.722579475930852, 14.733491156679111, 5.165569618226624, 9.688354701893642, 6.479069318888546, 20.850962894163636, 9.517166612950168, 5.858366092676899, 2.5683251920045524, 7.371697549290886, 18.200960540406633, 16.508036787385965, 1.5024063653889765, 14.204383850658854, 29.24584463864564, 15.40319946529917}, Consumed: []float64{599.2974999999994, 216.2282500000007, 426.8567499999986, 467.16999999999916, 315.3309999999992, 190.87775000000002, 246.9822499999999, 162.88624999999954, 315.95149999999916, 368.9225000000006, 247.95199999999966, 231.1939999999989, 88.12875000000031, 191.16824999999994, 214.1225000000001, 130.34924999999984, 164.70399999999984, 290.97025000000014, 68.93600000000035, 142.50249999999986, 101.8014999999996, 291.0504999999993, 123.60150000000021, 104.03450000000043, 64.51699999999946, 150.15575000000004, 280.15425000000016, 330.62975000000006, 32.19600000000047, 226.94350000000006, 442.19450000000046, 257.09149999999977}, Produced: []float64{475.0499999999992}, TotalProduced: 475.0499999999992},
			{Id: "MRP/2021/02", Allocated: []float64{187.14983289462134, 85.56113766660154, 109.79987261483416, 121.17755794399407, 92.38617560583317, 63.03948342239993, 82.2664919594089, 38.554522506555806, 79.84554719756493, 94.2160944982477, 75.1014947034028, 61.477839831382745, 28.062521921649903, 50.99621885594203, 95.61217427360079, 36.98376924853149, 39.26393833275646, 57.707211091688244, 23.783591600826963, 31.260605014520333, 24.840839812148925, 97.53834837275477, 39.262101614246, 32.69134782231723, 16.12977134171862, 47.074481072873795, 97.92460305785902, 68.9125797439097, 8.06661510939647, 64.52448587581937, 142.76357608200306, 83.81491891059022}, Consumed: []float64{554.4332500000003, 205.97025000000028, 282.42775000000023, 420.13275000000095, 248.87725000000003, 155.4550000000001, 187.32499999999987, 119.81574999999945, 235.60225000000003, 351.05074999999925, 204.4090000000002, 199.77599999999927, 80.87775000000016, 116.85499999999935, 204.25100000000015, 125.14200000000005, 132.41800000000123, 206.3679999999998, 57.71125000000023, 103.53074999999939, 87.13924999999985, 241.01150000000092, 100.19550000000042, 89.84450000000047, 57.10824999999917, 145.2395000000001, 244.46525000000048, 219.93299999999977, 26.981500000000374, 214.12774999999996, 369.3939999999993, 232.70125000000007}, Produced: []float64{2448.589500000004}, TotalProduced: 2448.589500000004},
			{Id: "MRP/2021/03", Allocated: []float64{227.34524105730554, 106.69611212351273, 141.4869135113773, 134.83197696825303, 103.22009553526514, 103.84730173530495, 111.32905525379988, 57.72285841100358, 105.59390621394883, 78.87094738288376, 95.31620173011487, 102.95746540943357, 27.456456179440824, 122.20510743726713, 105.68002500077775, 42.98403488025432, 42.89853707896101, 83.60772983169349, 25.168897631869747, 31.92330774698331, 29.378354703968753, 148.87772742973462, 44.52610747568248, 37.94158576354778, 21.772865245081928, 39.683916551228776, 115.91064516888652, 80.8223302218245, 10.66700929966817, 48.64641880137419, 160.91653492399374, 85.31208329555768}, Consumed: []float64{619.1580000000001, 238.08150000000072, 306.74225000000007, 424.8784999999992, 271.82925, 211.72699999999944, 261.4432500000004, 144.96524999999983, 262.0885000000004, 294.571000000001, 233.4017500000001, 256.37999999999874, 81.5220000000001, 303.73125, 223.1442500000002, 134.92950000000042, 106.66300000000088, 268.7147499999998, 60.9029999999995, 101.35049999999923, 89.72074999999987, 312.0167500000012, 109.37675000000004, 111.31199999999987, 71.93724999999952, 123.27475, 270.32200000000006, 249.37725000000052, 34.304500000000566, 163.11325, 388.99999999999983, 227.21525000000094}, Produced: []float64{3623.468999999997}, TotalProduced: 3623.468999999997},
			{Id: "MRP/2021/04", Allocated: []float64{288.6409728407094, 162.91513887225875, 170.99169476050108, 188.48330109225952, 136.84415399311493, 118.814849451301, 140.23710837627576, 72.07449682150505, 326.7788110367398, 118.62527215331274, 124.11671386651616, 126.13350316934546, 39.352521388214264, 80.1184661908016, 152.69945978022383, 74.88501499719357, 50.59168077547027, 97.10726431948122, 33.84524683056675, 57.09407900498272, 38.36908897473682, 111.59281839674802, 62.588667930114944, 51.36259968845859, 32.396257935074075, 83.31276432436552, 150.10328547707238, 107.28822708419185, 15.043053893632063, 41.19256463691592, 209.21963230829337, 123.51003962962511}, Consumed: []float64{565.0867499999995, 253.51000000000138, 332.489249999999, 400.2662499999998, 259.19900000000024, 193.5752500000007, 246.79200000000017, 126.34624999999993, 446.9372500000007, 284.51050000000015, 228.69874999999996, 222.835999999999, 76.84924999999991, 125.64399999999938, 223.3175000000003, 159.86125000000004, 96.63100000000108, 214.0370000000001, 58.404749999999645, 98.26274999999963, 77.83399999999978, 183.54325000000048, 99.67825000000028, 97.72550000000008, 65.80774999999957, 156.72075000000007, 248.05974999999953, 211.1002499999993, 30.59200000000024, 102.40125000000012, 375.77875000000046, 237.28875}, Produced: []float64{5573.893500000005}, TotalProduced: 5573.893500000005},
			{Id: "MRP/2021/05", Allocated: []float64{319.16108082464865, 202.184179792652, 207.16559568432135, 223.50819291400487, 162.31598894167627, 145.36378251568254, 98.55466548025532, 75.34886761199748, 408.9207768240128, 147.21958536704108, 132.64164816342267, 145.71524431020893, 47.701126749198956, 120.27863260138714, 140.8334231508733, 87.58813655280642, 56.04163831549155, 155.24009786222157, 49.812891911721785, 71.74390782429403, 43.972129136922476, 129.24303954261626, 66.39423208660202, 55.03455576834357, 39.34627674980386, 90.20745687679204, 202.83309536162764, 157.2204816578066, 16.614666203192584, 135.80621704862196, 253.90272745471145, 116.98065871504116}, Consumed: []float64{558.2852500000013, 275.9605000000026, 308.9282499999998, 423.0104999999999, 261.8337500000006, 205.7102500000003, 167.78224999999907, 121.51974999999956, 525.6119999999994, 303.60900000000146, 215.37400000000056, 217.2609999999989, 80.00849999999961, 263.25825000000043, 192.40325000000018, 142.32049999999973, 102.23600000000079, 273.1259999999999, 68.65949999999978, 111.94299999999987, 75.86400000000008, 182.28525000000135, 94.8987499999998, 89.56025000000032, 63.143249999999725, 152.91049999999993, 283.70225000000056, 235.03749999999937, 30.685500000000363, 229.21674999999996, 374.16949999999974, 188.71950000000018}, Produced: []float64{6701.9340000000175}, TotalProduced: 6701.9340000000175},
			{Id: "MRP/2021/06", Allocated: []float64{334.0244548327845, 227.85830118782974, 203.1795744644859, 111.33528188881483, 137.58302599622462, 106.84166630799177, 130.8452721994444, 63.44934402361016, 298.67672178318475, 148.71816332977534, 123.14532465630698, 83.91632752415083, 57.494291675158905, 120.95075898318736, 167.2440988612225, 76.38437389976959, 72.23597389063856, 81.69118430316536, 51.89460548504552, 56.4183910594886, 47.62481218998818, 150.96450838369057, 88.90793948673918, 63.21539663670129, 35.08197967334693, 89.26958746302142, 206.0728865563229, 91.4557617191781, 22.36518805125368, 176.36625866108838, 155.6364776320017, 101.67081719438966}, Consumed: []float64{475.8800000000021, 268.887750000004, 258.57549999999975, 179.29049999999972, 191.0187499999995, 135.62225000000112, 180.0245, 87.61375000000041, 350.3674999999996, 230.65700000000078, 168.6354999999999, 115.44100000000051, 80.14075000000031, 283.4952499999994, 201.69449999999986, 113.57725000000002, 102.4910000000015, 116.9950000000007, 63.906500000000406, 76.25324999999897, 66.42300000000014, 202.37925000000038, 107.74049999999978, 87.4115000000005, 52.159499999999625, 131.62100000000007, 248.43625000000105, 112.50124999999989, 35.50100000000028, 253.59724999999983, 207.4457500000009, 132.69275000000042}, Produced: []float64{9253.684500000005}, TotalProduced: 9253.684500000005},
			{Id: "MRP/2021/07", Allocated: []float64{328.90746338073257, 226.20898139729445, 206.69287532982082, 103.7088264869402, 122.65548980861092, 142.90742058103976, 63.05535009922894, 70.43088032175325, 292.4707339065031, 151.73352795615097, 123.75140630288458, 145.14997184978847, 48.42628284043334, 71.00535291488009, 153.34826176920018, 85.16811101093441, 79.63028762904973, 58.60819885909641, 44.734588513627926, 50.005803863678224, 48.45280742510248, 136.6173788827407, 82.04486301122529, 49.03609384389709, 35.82495289157389, 77.26501797329372, 187.96255416838991, 81.77124971758916, 20.961402118905905, 183.05786370714472, 158.81671748235087, 84.21953395613716}, Consumed: []float64{514.9004999999989, 287.6127500000019, 284.4165000000005, 184.90600000000052, 205.95049999999964, 185.6595000000008, 102.07200000000024, 100.81450000000021, 370.13949999999903, 280.7029999999985, 181.42224999999937, 200.8819999999998, 74.10825000000006, 97.4217499999998, 195.49874999999966, 133.67374999999987, 121.96900000000122, 95.55699999999965, 59.56200000000023, 71.19274999999924, 72.56525000000025, 191.25400000000042, 105.7607499999995, 77.50675000000038, 52.435249999999364, 130.86649999999943, 254.9115, 111.6427499999999, 35.85525000000002, 263.69725000000005, 251.3025000000002, 129.18850000000023}, Produced: []float64{7691.601000000016}, TotalProduced: 7691.601000000016},
			{Id: "MRP/2021/08", Allocated: []float64{272.524249195005, 189.1721871143012, 221.4043724331966, 0.40224974883541703, 117.06443829750283, 144.1883212300176, 61.47277760564082, 79.3652234205034, 274.4977858765652, 121.53127957079658, 121.98078589134877, 133.63725568798628, 48.17289603499021, 107.29750411027698, 164.99667218140883, 71.44257656329376, 59.2677798941352, 54.65955689805343, 44.346646117107596, 54.76837745902818, 39.75468628812698, 130.996048929374, 74.39794899907315, 53.50640148478348, 27.58370524105219, 94.3374508187366, 172.78645536236783, 85.64641430191492, 18.27776268403069, 156.00937500352924, 203.32248452827235, 79.71691102874529}, Consumed: []float64{487.6820000000001, 270.8622500000015, 339.6922500000006, 0.9939839999999982, 205.12349999999958, 200.19750000000016, 109.50924999999992, 124.34874999999963, 374.5192500000012, 270.4452499999996, 189.75374999999997, 197.0619999999994, 81.93874999999983, 195.88399999999825, 228.93349999999987, 134.81625000000008, 108.19100000000111, 97.74725000000018, 64.48250000000041, 85.02074999999866, 70.91900000000025, 203.51374999999894, 106.53050000000016, 92.86850000000041, 49.589999999999684, 154.5354999999999, 260.91200000000026, 147.32100000000037, 34.941000000000166, 251.51075000000048, 309.45325, 130.64025000000044}, Produced: []float64{5983.222499999999}, TotalProduced: 5983.222499999999},
			{Id: "MRP/2021/09", Allocated: []float64{270.72679205227587, 186.75874210295302, 173.24214520489429, 0, 105.53303204943641, 135.9552394368988, 96.21752514781419, 43.19893517054622, 226.1868896438013, 129.4503006426358, 87.4411624310655, 120.24611161978164, 47.7154934200478, 67.87573003243696, 109.11913997575347, 64.32085565809474, 55.33332470203694, 60.51588105126997, 40.71989641047588, 41.97639544308079, 38.573852871176754, 91.74700942073258, 65.13556304752525, 46.104953147339195, 29.376235934093376, 82.53332499246446, 155.25803618359978, 114.69709618730295, 15.78694128585597, 145.9547403386807, 199.5417597147074, 70.10181568122083}, Consumed: []float64{504.6907840000012, 275.2087180000015, 269.6150239999995, 0, 197.79974599999963, 183.2449680000023, 170.28000000000043, 76.84550199999981, 313.242468000001, 287.01404200000263, 155.29277399999964, 204.39101599999807, 83.49525200000028, 155.13325999999861, 169.34698400000045, 125.01846799999919, 103.79701600000095, 117.72721800000083, 59.39154600000014, 60.94001599999999, 71.79599600000033, 152.3814979999996, 99.02372400000047, 83.77126200000022, 57.397717999999664, 137.41596600000028, 246.53898399999898, 189.44775600000023, 31.525740000000066, 250.35571600000105, 312.9679860000002, 122.68498600000062}, Produced: []float64{5518.587000000004}, TotalProduced: 5518.587000000004},
			{Id: "MRP/2021/10", Allocated: []float64{225.55053201952686, 146.49657458456437, 150.49923009700294, 0, 91.66665057951508, 76.14126342547004, 87.6048834694243, 38.92170170232418, 121.22717944930142, 98.12395129122123, 101.79211827885815, 103.21101003620801, 28.517095484465738, 137.5012292652754, 65.70332740296516, 42.01437353058342, 37.99018024309023, 70.68757605974398, 27.045677717366083, 28.85313969681413, 23.77926771470264, 54.15179263394788, 55.53446695343082, 31.765511656706625, 31.553065502896438, 60.23480393179455, 102.69307863815735, 95.98366395436321, 9.837837430800892, 106.2865682943466, 171.85918503223303, 105.00806392289874}, Consumed: []float64{602.0229999999998, 301.6710000000014, 330.46549999999985, 0, 231.31024999999926, 162.98825000000105, 205.0017499999999, 103.66299999999971, 269.65275000000025, 313.37475000000006, 242.38750000000013, 254.41099999999892, 88.2950000000002, 246.06449999999788, 152.1605000000002, 124.74550000000004, 117.45400000000082, 215.6119999999998, 57.604250000000285, 55.872249999999454, 80.1950000000003, 151.10499999999902, 114.2672500000004, 87.12350000000104, 86.4865, 126.30550000000056, 257.26100000000054, 265.03424999999925, 29.66200000000044, 284.52874999999995, 390.0670000000006, 278.80650000000014}, Produced: []float64{3074.6579999999994}, TotalProduced: 3074.6579999999994},
			{Id: "MRP/2021/11", Allocated: []float64{101.83635129313576, 56.65860644088942, 52.96778991130992, 0, 37.82714012270532, 44.98498131208121, 48.41735982976029, 20.05492116180073, 51.393753965117, 41.98151248089519, 47.62427156338209, 38.073404546456764, 13.357774829390957, 41.971928458582674, 36.56386361005103, 19.10945999579417, 20.498307469617863, 38.861281408976524, 12.052181964224816, 9.854377670155829, 13.767555618545648, 30.797824397250665, 25.480371663783156, 14.32346481031671, 18.373589992476624, 28.517492637746862, 52.38045908989714, 41.26144729364693, 4.242735836201921, 50.494365337778326, 86.25631474014456, 59.315110547883435}, Consumed: []float64{586.9142500000005, 269.6862500000019, 288.6937500000003, 0, 242.0149999999992, 158.32225000000014, 187.91049999999925, 140.55299999999997, 284.4517499999996, 332.29674999999884, 239.93749999999983, 252.79399999999933, 86.56974999999976, 322.9562500000001, 162.03825000000003, 129.08875, 126.70000000000077, 272.3317499999999, 60.2377500000004, 60.63074999999957, 83.75549999999974, 181.16624999999982, 114.13349999999996, 97.75125000000014, 93.90074999999966, 133.21350000000015, 289.6409999999998, 295.6195, 28.099000000000384, 318.4155000000002, 423.39074999999957, 311.2067500000012}, Produced: []float64{1229.9220000000014}, TotalProduced: 1229.9220000000014},
			{Id: "MRP/2021/12", Allocated: []float64{63.79203476718046, 37.153531970634354, 37.48699586442753, 0, 24.622093269180287, 26.728306494994523, 34.44658095629455, 17.29162238988202, 31.26263263305481, 27.65993401678165, 29.483875753873903, 23.960434016953723, 8.713383006097498, 19.558747327620225, 29.912956524510538, 17.884058870726435, 15.155038291076696, 27.250584776895124, 9.263660617649006, 7.194368227697419, 9.077858225067246, 21.10670479692164, 15.9809721814289, 9.874435493507852, 7.131536531462348, 13.788562543290704, 40.33762128203732, 27.777806229090842, 2.7775784010766134, 26.300528205507877, 53.43950092940426, 37.53330540567347}, Consumed: []float64{624.8767499999998, 282.8937500000013, 379.5522499999999, 0, 275.9442500000001, 160.47174999999976, 293.18974999999955, 165.52500000000055, 290.58925000000005, 378.6779999999994, 265.05449999999985, 241.56899999999922, 83.32950000000118, 250.9077500000004, 182.36575000000025, 158.63199999999983, 150.16500000000053, 311.0822499999996, 64.33700000000039, 64.11800000000014, 83.91075000000015, 198.1419999999994, 126.57625000000019, 109.8499999999997, 65.03000000000021, 115.46425000000048, 312.6135000000005, 272.75424999999956, 31.80275000000051, 302.9362500000001, 419.5374999999998, 314.30050000000125}, Produced: []float64{772.8494999999992}, TotalProduced: 772.8494999999992},
		}

		assert.Equal(t, results, expectedResult)
	})

	t.Run("calculate weekly report", func(t *testing.T) {
		results, report, err := calculation.CalculateWeeklyReport(db, 2021, 4, calculation.CalculateEEG)
		require.NoError(t, err)

		require.NotNil(t, results)
		require.NotNil(t, report)
		require.NotNil(t, report.Allocated)

		fmt.Printf("Results: %+v\n", results)
		fmt.Printf("Report: %+v\n", report)

		fmt.Println("Results:")
		for _, r := range results {
			fmt.Printf("%+v\n", r)
		}
		fmt.Println("---------")

		expectedResult := []*model.EnergyReport{
			{Id: "WRP/2021/04/01",
				Allocated:     []float64{10.694395118167739, 6.216645031801386, 5.500512025405309, 6.754333198657755, 3.1865359660168986, 8.134404641303474, 5.06544268744124, 1.367590883777918, 6.667514077293756, 4.2107942218018435, 6.428908861255079, 7.202596449766271, 1.390592024264578, 2.287389121647259, 9.335844724004286, 1.847196251634725, 0.9879306591537823, 3.2550395019073024, 0.6037496836755271, 3.4816898564398753, 2.3612636546856907, 4.1347849135276, 3.188446955496431, 2.624920244018871, 0.6549812477940722, 1.8996083884004669, 6.6108855743159705, 2.189172133105621, 0.5203641418134429, 1.6750583477122807, 10.587324045325799, 4.65333536838775},
				Consumed:      []float64{18.286749999999998, 8.58, 8.822000000000005, 13.481500000000006, 5.6822500000000025, 9.253249999999998, 7.6875, 4.316000000000001, 9.142999999999999, 7.530749999999998, 9.2845, 8.871999999999996, 2.2040000000000006, 3.5887499999999997, 11.171499999999996, 4.268750000000001, 2.2029999999999994, 6.509750000000002, 1.1372499999999997, 4.548749999999998, 3.6189999999999984, 5.791249999999995, 4.427250000000001, 5.038499999999998, 1.2584999999999995, 3.7770000000000015, 8.880499999999998, 4.02075, 0.9902499999999999, 5.01325, 12.863749999999996, 8.305000000000001},
				Produced:      []float64{238.9545},
				TotalProduced: 238.9545,
			},
			{Id: "WRP/2021/04/02",
				Allocated:     []float64{11.843365752841645, 5.6015560833992, 4.457802727170282, 8.029377158431263, 3.181238146853345, 2.643019700614921, 5.145526140327518, 1.5906521434695575, 5.505238260000745, 3.5949924349427413, 4.083431978964615, 4.85337666420366, 2.168953528321724, 3.7173190314109306, 8.735379019135028, 3.126580250373606, 3.399975058611172, 3.9752496990649, 0.8255168414606533, 2.419148870704692, 3.8882361163735863, 4.155165864627362, 1.596790425886767, 2.856260555852949, 0.6772123571041471, 2.7521095824216197, 6.070667464737086, 4.975950647674643, 0.5276426011418466, 1.7130795291806118, 5.683431069876102, 6.678004294821084},
				Consumed:      []float64{19.057750000000002, 7.76375, 6.4487499999999995, 15.309249999999995, 5.459, 3.7867500000000023, 8.069, 2.6472500000000005, 7.993750000000001, 6.633749999999998, 7.2109999999999985, 6.901000000000002, 3.081750000000001, 4.756250000000002, 10.137500000000001, 4.63425, 4.653999999999998, 8.016499999999999, 1.3279999999999996, 2.9342500000000005, 4.861500000000001, 5.507249999999999, 2.4470000000000005, 3.8547500000000015, 1.2645000000000002, 4.884250000000001, 7.61725, 7.789500000000001, 0.9754999999999997, 3.1557500000000007, 9.300999999999998, 10.137500000000001},
				Produced:      []float64{156.02250000000004},
				TotalProduced: 156.02250000000004,
			},
		}
		expectedReport := &model.EnergyReport{
			Id: "MRP/2021/04",
			Allocated: []float64{
				288.6409728407094, 162.9151388722588, 170.99169476050096, 188.483301092259,
				136.84415399311493, 118.81484945130057, 140.23710837627564, 72.07449682150492,
				326.77881103673946, 118.62527215331247, 124.11671386651602, 126.13350316934512,
				39.352521388214114, 80.11846619080164, 152.6994597802239, 74.88501499719344,
				50.59168077547026, 97.10726431948108, 33.84524683056678, 57.09407900498315, 38.36908897473679,
				111.59281839674811, 62.58866793011516, 51.362599688458566, 32.3962579350741, 83.31276432436542,
				150.10328547707215, 107.28822708419175, 15.043053893632024, 41.19256463691594, 209.21963230829328,
				123.51003962962506},
			Consumed: []float64{
				565.0867499999998, 253.51000000000005, 332.48924999999997, 400.26625, 259.199, 193.57524999999998,
				246.79199999999997, 126.34625000000001, 446.93725000000006, 284.5105000000001, 228.69874999999993,
				222.83600000000004, 76.84925, 125.64399999999999, 223.31750000000002, 159.86124999999998,
				96.63099999999997, 214.03700000000006, 58.40474999999999, 98.26274999999998, 77.83399999999997,
				183.54325, 99.67825000000003, 97.7255, 65.80775, 156.72074999999998, 248.05975, 211.10025,
				30.591999999999985, 102.40125, 375.77874999999995, 237.28875000000002},
			Produced: []float64{
				5573.8935},
			TotalProduced: 5573.8935}

		assert.Equal(t, expectedReport, report)
		assert.Equal(t, expectedResult[0], results[0])
		assert.Equal(t, expectedResult[1], results[1])
	})

	t.Run("calculate row only report", func(t *testing.T) {
		am, cm, pm, ps := calculation.CalculateEEG(db, fmt.Sprintf("%s/%.2d/18/05/30/00", "2021", 4))
		fmt.Printf("Production Sum: %+v\n", ps)
		require.NotNil(t, am)
		require.NotNil(t, cm)
		require.NotNil(t, pm)

		fmt.Printf("Allocation: %+v\n", am)
		fmt.Printf("Consumtion: %+v\n", cm)
		fmt.Printf("Production: %+v\n", pm)

		expectedConsumption := []float64{0.155750, 0.016250, 0.152750, 0.026500, 0.047500, 0.021750, 0.059000,
			0.019000, 0.048250, 0.099750, 0.016750, 0.029000, 0.003750, 0.008000, 0.012250, 0.022500, 0.023000,
			0.075500, 0.002250, 0.036500, 0.007750, 0.010250, 0.005500, 0.030000, 0.008250, 0.059750, 0.030250,
			0.004250, 0.021000, 0.015750, 0.041250, 0.066250}

		assert.ElementsMatch(t, cm.Elements, expectedConsumption)
		require.True(t, ps == 0.0)

	})

	t.Run("calculate monthly dashboards", func(t *testing.T) {
		err = calculation.CalculateMonthlyDash(db, fmt.Sprintf("%d", 2021), calculation.CalculateEEG)
		require.Nil(t, err)
	})
}

func TestCalculateBadImport(t *testing.T) {
	db, err := store.OpenStorageTest("excelsource", "../test/rawdata")
	require.NoError(t, err)
	defer func() {
		db.Close()
		os.RemoveAll("../test/rawdata/excelsource")
	}()

	empty := true
	for _, k := range ImportTestContent(t, "./221220 Daten VIERE 04-10 bis 18-12.xlsx", "Energiedaten", db) {
		err = calculation.CalculateMonthlyDash(db, fmt.Sprintf("%d", k), calculation.CalculateEEG)
		require.NoError(t, err)
		empty = false
	}
	require.Equal(t, false, empty)

	t.Run("Calc yearly report", func(t *testing.T) {
		results, report, err := calculation.CalculateYearlyReport(db, 2022, calculation.CalculateEEG)
		require.NoError(t, err)
		require.NotNil(t, results)
		require.NotNil(t, report)
		require.NotNil(t, report.Allocated)

		fmt.Printf("Result: %+v\n", results)
		fmt.Printf("Allocated: %+v\n", report.Allocated)
		fmt.Printf("Consumed:  %+v\n", report.Consumed)
		fmt.Printf("TotalProduced:  %+v\n", report.TotalProduced)
	})
}
